---
title: "Mappeoppgave1_v2"
format: pdf
editor: visual
echo: false
warning : false
---

### Oppgave 1

Lag to til fire figurer som sammenligninger sysselsetting, produksjon, bruttoprodukt, og bruttoprodukt per sysselsatt på tvers av næringer i 2021. Sysselsetting oppgis i antall årsverk, produksjon, bruttoprodukt, og bruttoprodukt per sysselsatt i løpende priser. Dere må selv avgjøre hvilke tall som er meningsfylte å sammenligne og hvorvidt dere ønsker å dele opp tallene i ulike figurer.

```{r}
#| warning: false
rm(list = ls())
suppressPackageStartupMessages({
library(tidyverse)
library(httr)
library(rjstat)
library(janitor)
library(gdata)
})
```

```{r}
url <- "https://data.ssb.no/api/v0/no/table/09171/"

query <- '{
  "query": [
    {
      "code": "NACE",
      "selection": {
        "filter": "item",
        "values": [
          "nr23_6",
          "pub2X01_02",
          "pub2X03",
          "pub2X05",
          "nr2X06_09",
          "nr23ind",
          "pub2X35",
          "pub2X36_39",
          "pub2X41_43",
          "pub2X45_47",
          "pub2X49B",
          "pub2X50A",
          "pub2X49A_52",
          "pub2X53",
          "pub2X55_56",
          "pub2X58_63",
          "pub2X64_66",
          "pub2X68A",
          "pub2X68B",
          "pub2X69_75",
          "pub2X77_82",
          "pub2X84",
          "pub2X85",
          "pub2X86_88",
          "pub2X90_97",
          "nr23_6fn",
          "nr23mark",
          "nrimark"
        ]
      }
    },
    {
      "code": "ContentsCode",
      "selection": {
        "filter": "item",
        "values": [
          "Prob",
          "BNPB"
        ]
      }
    }
  ],
  "response": {
    "format": "json-stat2"
  }
}'
  
tabell.tmp <- url %>%
  POST(body = query, encode = "json")

df <- tabell.tmp %>%
  content("text") %>%
  fromJSONstat() %>%
  as_tibble()  
```

```{r}
df <- df %>% 
  separate(kvartal,c("År","Kvartal"),"K") %>% 
  select(-Kvartal) %>% 
  filter(År==2021) 

dfprod <- df %>% 
  filter(statistikkvariabel == "Produksjon i basisverdi. Løpende priser (mill. kr)" ) %>% 
  group_by(næring) %>% 
  summarise(produksjon = sum(value))

dfbruttoprod <- df %>% 
  filter(statistikkvariabel == "Bruttoprodukt i basisverdi. Løpende priser (mill. kr)" ) %>% 
  group_by(næring) %>% 
  summarise(bruttoprodukt = sum(value)) %>% 
  select(-næring)

df_tidy <- cbind(dfprod,dfbruttoprod)
```

```{r}
url2 <- "https://data.ssb.no/api/v0/no/table/09789"

query <- '{
  "query": [
    {
      "code": "NACE2007",
      "selection": {
        "filter": "item",
        "values": [
          "00-99",
          "01-02",
          "03",
          "05-09",
          "10-33",
          "35-39",
          "41-43",
          "45-47",
          "49-53",
          "55-56",
          "58-63",
          "64-66",
          "68-82",
          "84",
          "85",
          "86-88",
          "90-99"
        ]
      }
    },
    {
      "code": "Tid",
      "selection": {
        "filter": "item",
        "values": [
          "2021"
        ]
      }
    }
  ],
  "response": {
    "format": "json-stat2"
  }
}'

tabell2.tmp <- url2 %>%
  POST(body = query, encode = "json")

df2 <- tabell2.tmp %>%
  content("text") %>%
  fromJSONstat() %>%
  as_tibble()  
```

```{r}
df_fig <- df_tidy %>% 
  filter(næring == "Offentlig administrasjon og forsvar" 
         | næring == "Industri" 
         | næring == "Bygge- og anleggsvirksomhet" 
         | næring == "Helse- og omsorgstjenester" 
         | næring == "Utvinning av råolje og naturgass, inkl. tjenester" 
         | næring == "Varehandel og reparasjon av motorvogner") %>% 
  mutate(bruttoprodukt = bruttoprodukt*0.001) %>% 
  mutate(produksjon = produksjon*0.001)

fig <- ggplot(data = df_fig,aes(x=næring, y = produksjon)) + geom_col() + theme_minimal() + theme(axis.text.x = element_text(angle = 48, hjust = 1)) + ylab("") + ggtitle("Produksjon i de fem største næringene (2021)", subtitle = "- Målt i milliarder (løpende priser)") 

fig
```

```{r}
df2 <- df2 %>% 
  rename(næring = "næring (SN2007)") %>% 
  rename(sysselsetting = "value") %>% 
  mutate(prosent = sysselsetting/2774*100)
```

```{r}
df2 %>% 
  filter(næring != "Alle næringer") %>% 
  ggplot(aes(y=næring, x= prosent)) + theme_bw() + geom_col() + theme(axis.text.x = element_text(angle = 40,hjust = 1)) + ggtitle("Sysselsetting etter næring (2021)", subtitle = "- Årsverk i prosent") + ylab("Sysselsatte")
```

### Oppgave 3

Lag figurer som viser bruttoprodukt per næring i både faste og løpende priser mellom 2011 og 2021. Diskuter hvorvidt det er noen næringer hvor variasjon i produktprisene har særlig stor innvirkning på verdien av bruttoproduksjonen.

```{r}
url3 <- "https://data.ssb.no/api/v0/no/table/09171"

query <- '{
  "query": [
    {
      "code": "NACE",
      "selection": {
        "filter": "item",
        "values": [
          "pub2X01_02",
          "pub2X03",
          "pub2X05",
          "nr2X06_09",
          "nr23ind",
          "pub2X35",
          "pub2X36_39",
          "pub2X41_43",
          "pub2X45_47",
          "pub2X49B",
          "pub2X50A",
          "pub2X49A_52",
          "pub2X53",
          "pub2X55_56",
          "pub2X58_63",
          "pub2X64_66",
          "pub2X68A",
          "pub2X68B",
          "pub2X69_75",
          "pub2X77_82",
          "pub2X84",
          "pub2X85",
          "pub2X86_88",
          "pub2X90_97"
        ]
      }
    },
    {
      "code": "ContentsCode",
      "selection": {
        "filter": "item",
        "values": [
          "BNPB",
          "BNPB2"
        ]
      }
    },
    {
      "code": "Tid",
      "selection": {
        "filter": "item",
        "values": [
          "2011K1",
          "2011K2",
          "2011K3",
          "2011K4",
          "2012K1",
          "2012K2",
          "2012K3",
          "2012K4",
          "2013K1",
          "2013K2",
          "2013K3",
          "2013K4",
          "2014K1",
          "2014K2",
          "2014K3",
          "2014K4",
          "2015K1",
          "2015K2",
          "2015K3",
          "2015K4",
          "2016K1",
          "2016K2",
          "2016K3",
          "2016K4",
          "2017K1",
          "2017K2",
          "2017K3",
          "2017K4",
          "2018K1",
          "2018K2",
          "2018K3",
          "2018K4",
          "2019K1",
          "2019K2",
          "2019K3",
          "2019K4",
          "2020K1",
          "2020K2",
          "2020K3",
          "2020K4",
          "2021K1",
          "2021K2",
          "2021K3",
          "2021K4"
        ]
      }
    }
  ],
  "response": {
    "format": "json-stat2"
  }
}'

tabell3.tmp <- url %>%
  POST(body = query, encode = "json")

df3 <- tabell3.tmp %>%
  content("text") %>%
  fromJSONstat() %>%
  as_tibble()  
```

```{r}
df3 <- df3 %>% 
  separate(kvartal,c("År","Kvartal"),"K") %>% 
  select(-Kvartal)
```

```{r}
dfbruttoprod_lop <- df3 %>% 
  filter(statistikkvariabel == "Bruttoprodukt i basisverdi. Løpende priser (mill. kr)" ) %>% 
  group_by(næring, År) %>% 
  mutate(bruttoproduksjon  = sum(value)) %>% 
  select(-value) %>% 
  distinct()

dfbruttoprod_lop <- dfbruttoprod_lop %>% 
  filter(næring == "Offentlig administrasjon og forsvar" 
         | næring == "Industri" 
         | næring == "Bygge- og anleggsvirksomhet" 
         | næring == "Helse- og omsorgstjenester" 
         | næring == "Utvinning av råolje og naturgass, inkl. tjenester" 
         | næring == "Varehandel og reparasjon av motorvogner") %>% 
  mutate(År = as.numeric(År))
```

```{r}
dfbruttoprod_fast <- df3 %>% 
  filter(statistikkvariabel == "Bruttoprodukt i basisverdi. Faste 2020-priser (mill. kr)" ) %>% 
  group_by(næring, År) %>% 
  mutate(bruttoproduksjon_reel  = sum(value)) %>% 
  select(-value) %>% 
  distinct()

dfbruttoprod_fast <- dfbruttoprod_fast %>% 
  filter(næring == "Offentlig administrasjon og forsvar" 
         | næring == "Industri" 
         | næring == "Bygge- og anleggsvirksomhet" 
         | næring == "Helse- og omsorgstjenester" 
         | næring == "Utvinning av råolje og naturgass, inkl. tjenester" 
         | næring == "Varehandel og reparasjon av motorvogner") %>% 
  mutate(År = as.numeric(År))
```

```{r}
ggplot() + 
  geom_line(data = dfbruttoprod_fast, aes(År, bruttoproduksjon_reel, col = "Faste priser")) + ylab("") + xlab("") +
  geom_line(data = dfbruttoprod_lop, aes(År, bruttoproduksjon, col = "Løpende priser")) +  facet_wrap(~ næring) + theme_bw() + theme(axis.text.x = element_text(angle = 40,hjust = 1)) 
```
